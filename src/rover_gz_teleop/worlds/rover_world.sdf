<?xml version='1.0'?>
<sdf version='1.9'>
  <world name='stable_world'>
    <!-- Gravity is ON -->
    <gravity>0 0 -9.81</gravity>

    <!-- Use tighter physics to reduce jitter/flip -->
    <physics name='dart' type='dart'>
      <max_step_size>0.001</max_step_size>
      <real_time_update_rate>1000</real_time_update_rate>
    </physics>

    <scene>
      <!-- Light background -->
      <ambient>0.7 0.7 0.7 1</ambient>
      <background>0.96 0.97 1.0 1</background>
      <shadows>true</shadows>
    </scene>

    <!-- Ground -->
    <model name='ground'>
      <static>true</static>
      <link name='ground_link'>
        <collision name='ground_col'>
          <geometry>
            <plane><normal>0 0 1</normal><size>200 200</size></plane>
          </geometry>
          <surface>
            <friction>
              <ode>
                <mu>1.2</mu><mu2>1.2</mu2>
              </ode>
            </friction>
          </surface>
        </collision>
        <visual name='ground_vis'>
          <geometry>
            <plane><normal>0 0 1</normal><size>200 200</size></plane>
          </geometry>
          <material>
            <ambient>0.9 0.9 0.95 1</ambient>
            <diffuse>0.9 0.9 0.95 1</diffuse>
          </material>
        </visual>
      </link>
    </model>

    <!-- Sun -->
    <light type='directional' name='sun'>
      <cast_shadows>true</cast_shadows>
      <pose>0 0 10 0 0 0</pose>
      <diffuse>0.9 0.9 0.9 1</diffuse>
      <specular>0.2 0.2 0.2 1</specular>
      <direction>-0.5 0.4 -1</direction>
    </light>

    <!-- Rover -->
    <model name='rover'>
      <pose>0 0 0.12 0 0 0</pose>
      <static>false</static>
      <self_collide>false</self_collide>

      <!-- Base: heavier, COM lowered, added decay to kill oscillations -->
      <link name='base_link'>
        <pose>0 0 0.12 0 0 0</pose>
        <inertial>
          <mass>8.0</mass>
          <!-- lower center of mass by 2 cm -->
          <pose>0 0 -0.02 0 0 0</pose>
          <!-- inertia of 0.40 x 0.30 x 0.06 m box (kg·m²) -->
          <inertia>
            <ixx>0.0624</ixx><ixy>0</ixy><ixz>0</ixz>
            <iyy>0.1090666667</iyy><iyz>0</iyz>
            <izz>0.1666666667</izz>
          </inertia>
        </inertial>
        <velocity_decay>
          <linear>0.05</linear>
          <angular>0.10</angular>
        </velocity_decay>
        <visual name='base_vis'>
          <geometry><box><size>0.40 0.30 0.06</size></box></geometry>
          <material>
            <ambient>0.2 0.4 0.9 1</ambient>
            <diffuse>0.2 0.4 0.9 1</diffuse>
          </material>
        </visual>
        <collision name='base_col'>
          <geometry><box><size>0.40 0.30 0.06</size></box></geometry>
          <surface>
            <contact>
              <stiffness>5e6</stiffness>
              <damping>1e4</damping>
              <restitution_coefficient>0.0</restitution_coefficient>
            </contact>
            <friction>
              <ode><mu>1.0</mu><mu2>1.0</mu2></ode>
            </friction>
          </surface>
        </collision>
      </link>

      <!-- Wheels: cylinder axis → +Y (roll=+90°). Placed outside base; tiny initial clearance. -->
      <!-- Wheel physical params chosen for stability: slightly heavier, realistic inertia, decay -->
      <!-- Common wheel geometry -->
      <!-- radius = 0.05, length(thickness) = 0.03 -->

      <link name='left_front_wheel'>
        <pose>0.15 0.18 0.051 0 0 0</pose>
        <self_collide>false</self_collide>
        <inertial>
          <mass>0.25</mass>
          <!-- Inertia of cylinder (axis = Y) -->
          <inertia>
            <!-- Ixx = Izz = (1/12)m(3r^2 + h^2) -->
            <ixx>0.000175</ixx><ixy>0</ixy><ixz>0</ixz>
            <!-- Iyy = (1/2) m r^2 -->
            <iyy>0.0003125</iyy><iyz>0</iyz>
            <izz>0.000175</izz>
          </inertia>
        </inertial>
        <velocity_decay><linear>0.02</linear><angular>0.02</angular></velocity_decay>
        <visual name='lf_vis'>
          <pose>0 0 0 1.5708 0 0</pose>
          <geometry><cylinder><radius>0.05</radius><length>0.03</length></cylinder></geometry>
          <material><ambient>0.1 0.1 0.1 1</ambient><diffuse>0.1 0.1 0.1 1</diffuse></material>
        </visual>
        <collision name='lf_col'>
          <pose>0 0 0 1.5708 0 0</pose>
          <geometry><cylinder><radius>0.05</radius><length>0.03</length></cylinder></geometry>
          <surface>
            <friction><ode><mu>1.2</mu><mu2>1.2</mu2></ode></friction>
            <contact><stiffness>5e6</stiffness><damping>1e4</damping></contact>
          </surface>
        </collision>
      </link>

      <link name='left_rear_wheel'>
        <pose>-0.15 0.18 0.051 0 0 0</pose>
        <self_collide>false</self_collide>
        <inertial>
          <mass>0.25</mass>
          <inertia>
            <ixx>0.000175</ixx><ixy>0</ixy><ixz>0</ixz>
            <iyy>0.0003125</iyy><iyz>0</iyz>
            <izz>0.000175</izz>
          </inertia>
        </inertial>
        <velocity_decay><linear>0.02</linear><angular>0.02</angular></velocity_decay>
        <visual name='lr_vis'>
          <pose>0 0 0 1.5708 0 0</pose>
          <geometry><cylinder><radius>0.05</radius><length>0.03</length></cylinder></geometry>
          <material><ambient>0.1 0.1 0.1 1</ambient><diffuse>0.1 0.1 0.1 1</diffuse></material>
        </visual>
        <collision name='lr_col'>
          <pose>0 0 0 1.5708 0 0</pose>
          <geometry><cylinder><radius>0.05</radius><length>0.03</length></cylinder></geometry>
          <surface>
            <friction><ode><mu>1.2</mu><mu2>1.2</mu2></ode></friction>
            <contact><stiffness>5e6</stiffness><damping>1e4</damping></contact>
          </surface>
        </collision>
      </link>

      <link name='right_front_wheel'>
        <pose>0.15 -0.18 0.051 0 0 0</pose>
        <self_collide>false</self_collide>
        <inertial>
          <mass>0.25</mass>
          <inertia>
            <ixx>0.000175</ixx><ixy>0</ixy><ixz>0</ixz>
            <iyy>0.0003125</iyy><iyz>0</iyz>
            <izz>0.000175</izz>
          </inertia>
        </inertial>
        <velocity_decay><linear>0.02</linear><angular>0.02</angular></velocity_decay>
        <visual name='rf_vis'>
          <pose>0 0 0 1.5708 0 0</pose>
          <geometry><cylinder><radius>0.05</radius><length>0.03</length></cylinder></geometry>
          <material><ambient>0.1 0.1 0.1 1</ambient><diffuse>0.1 0.1 0.1 1</diffuse></material>
        </visual>
        <collision name='rf_col'>
          <pose>0 0 0 1.5708 0 0</pose>
          <geometry><cylinder><radius>0.05</radius><length>0.03</length></cylinder></geometry>
          <surface>
            <friction><ode><mu>1.2</mu><mu2>1.2</mu2></ode></friction>
            <contact><stiffness>5e6</stiffness><damping>1e4</damping></contact>
          </surface>
        </collision>
      </link>

      <link name='right_rear_wheel'>
        <pose>-0.15 -0.18 0.051 0 0 0</pose>
        <self_collide>false</self_collide>
        <inertial>
          <mass>0.25</mass>
          <inertia>
            <ixx>0.000175</ixx><ixy>0</ixy><ixz>0</ixz>
            <iyy>0.0003125</iyy><iyz>0</iyz>
            <izz>0.000175</izz>
          </inertia>
        </inertial>
        <velocity_decay><linear>0.02</linear><angular>0.02</angular></velocity_decay>
        <visual name='rr_vis'>
          <pose>0 0 0 1.5708 0 0</pose>
          <geometry><cylinder><radius>0.05</radius><length>0.03</length></cylinder></geometry>
          <material><ambient>0.1 0.1 0.1 1</ambient><diffuse>0.1 0.1 0.1 1</diffuse></material>
        </visual>
        <collision name='rr_col'>
          <pose>0 0 0 1.5708 0 0</pose>
          <geometry><cylinder><radius>0.05</radius><length>0.03</length></cylinder></geometry>
          <surface>
            <friction><ode><mu>1.2</mu><mu2>1.2</mu2></ode></friction>
            <contact><stiffness>5e6</stiffness><damping>1e4</damping></contact>
          </surface>
        </collision>
      </link>

      <!-- Revolute joints: spin about +Y, with damping + friction + velocity/effort limits -->
      <joint name='left_front_wheel_joint' type='revolute'>
        <parent>base_link</parent><child>left_front_wheel</child>
        <axis>
          <xyz>0 1 0</xyz>
          <limit><lower>-1e16</lower><upper>1e16</upper><effort>15.0</effort><velocity>30.0</velocity></limit>
          <dynamics><damping>1.0</damping><friction>0.2</friction></dynamics>
        </axis>
      </joint>

      <joint name='left_rear_wheel_joint' type='revolute'>
        <parent>base_link</parent><child>left_rear_wheel</child>
        <axis>
          <xyz>0 1 0</xyz>
          <limit><lower>-1e16</lower><upper>1e16</upper><effort>15.0</effort><velocity>30.0</velocity></limit>
          <dynamics><damping>1.0</damping><friction>0.2</friction></dynamics>
        </axis>
      </joint>

      <joint name='right_front_wheel_joint' type='revolute'>
        <parent>base_link</parent><child>right_front_wheel</child>
        <axis>
          <xyz>0 1 0</xyz>
          <limit><lower>-1e16</lower><upper>1e16</upper><effort>15.0</effort><velocity>30.0</velocity></limit>
          <dynamics><damping>1.0</damping><friction>0.2</friction></dynamics>
        </axis>
      </joint>

      <joint name='right_rear_wheel_joint' type='revolute'>
        <parent>base_link</parent><child>right_rear_wheel</child>
        <axis>
          <xyz>0 1 0</xyz>
          <limit><lower>-1e16</lower><upper>1e16</upper><effort>15.0</effort><velocity>30.0</velocity></limit>
          <dynamics><damping>1.0</damping><friction>0.2</friction></dynamics>
        </axis>
      </joint>

      <!-- DiffDrive system (Ignition/Fortress) with speed/accel caps -->
      <plugin name="ignition::gazebo::systems::DiffDrive"
              filename="ignition-gazebo-diff-drive-system">
        <left_joint>left_front_wheel_joint</left_joint>
        <left_joint>left_rear_wheel_joint</left_joint>
        <right_joint>right_front_wheel_joint</right_joint>
        <right_joint>right_rear_wheel_joint</right_joint>

        <wheel_separation>0.36</wheel_separation>
        <wheel_radius>0.05</wheel_radius>

        <topic>/model/rover/cmd_vel</topic>
        <odom_topic>/model/rover/odometry</odom_topic>
        <odom_frame>odom</odom_frame>
        <robot_base_frame>base_link</robot_base_frame>
        <odom_publish_frequency>30</odom_publish_frequency>

        <!-- Caps to keep motion tame -->
        <max_linear_velocity>0.8</max_linear_velocity>
        <max_angular_velocity>1.5</max_angular_velocity>
        <max_linear_acceleration>0.5</max_linear_acceleration>
        <max_angular_acceleration>2.0</max_angular_acceleration>
        <cmd_timeout>0.25</cmd_timeout>
      </plugin>
    </model>
  </world>
</sdf>
